#!/bin/bash
#
echo "------------------------------"
echo " Merging DSE"
echo "------------------------------"

# Move to the top level of the repo
root="$(git rev-parse --show-toplevel)"
cd $root

# pull dse-private 
git remote rm dse-private 
git remote add dse-private https://github.com/mesosphere/dse-private.git
git fetch dse-private > /dev/null 2>&1 

# checkout each file in the merge list from dse-private/<latest-release> 
while read p; do
  echo $p
  # checkout
  git checkout tags/dse-2.0.0-5.1.2 $p
  # markdown files only
  if [ ${p: -3} == ".md" ]; then
  	# insert tag ( markdown files only )
    awk -v n=2 '/---/ { if (++count == n) sub(/---/, "---\n\n<!-- This source repo for this topic is https://github.com/mesosphere/dse-private -->\n"); } 1{print}' $p > tmp && mv tmp $p
  	# remove https://docs.mesosphere.com from spark links
	 awk '{gsub(/https:\/\/docs.mesosphere.com\/1.9\//,"/1.9/");}{print}' $p > tmp && mv tmp $p
	 awk '{gsub(/https:\/\/docs.mesosphere.com\/latest\//,"/latest/");}{print}' $p > tmp && mv tmp $p
	# add full path for images 
         awk '{gsub(/\(\/img/,"(/services/dse/v2.0.0-5.1.2/img");}{print}' $p > tmp && mv tmp $p
  fi

cp -r docs/* service-docs/dse/v2.0.0-5.1.2/
rm -r docs/

done <scripts/merge-lists/dse-private-merge-list.txt

echo "------------------------------"
echo " Beta DSE merge complete"
echo "------------------------------"
