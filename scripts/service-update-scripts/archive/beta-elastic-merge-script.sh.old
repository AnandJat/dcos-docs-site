#!/bin/bash
#
echo "-----------------------------------------"
echo " Merging beta elastic"
echo "-----------------------------------------"

# Move to the top level of the repo
root="$(git rev-parse --show-toplevel)"
cd $root

# pull dcos-commons
git remote rm dcos-commons
git remote add dcos-commons https://github.com/mesosphere/dcos-commons.git
git fetch dcos-commons > /dev/null 2>&1

# checkout each file in the merge list from dcos-commons/master
while read p; do
  echo $p
  # checkout
  git checkout tags/elastic-2.0.0-5.5.1 $p
  # markdown files only
  if [ ${p: -3} == ".md" ]; then
        # insert tag ( markdown files only )
    awk -v n=2 '/---/ { if (++count == n) sub(/---/, "---\n\n<!-- This source repo for this topic is https://github.com/mesosphere/dcos-commons -->\n"); } 1{print}' $p > tmp && mv tmp $p
        # remove https://docs.mesosphere.com from links
         awk '{gsub(/https:\/\/docs.mesosphere.com\/1.9\//,"/1.9/");}{print}' $p > tmp && mv tmp $p
         awk '{gsub(/https:\/\/docs.mesosphere.com\/latest\//,"/latest/");}{print}' $p > tmp && mv tmp $p
	# add full path for images
         awk '{gsub(/\(img/,"(/services/beta-elastic/v2.0.0-5.5.1/img");}{print}' $p > tmp && mv tmp $p
  fi

cp -r frameworks/elastic/docs/* service-docs/beta-elastic/v2.0.0-5.5.1 
rm -r frameworks/

done <scripts/merge-lists/beta-elastic-service-merge-list.txt

echo "------------------------------------------------"
echo " beta elastic merge complete"
echo "------------------------------------------------"
